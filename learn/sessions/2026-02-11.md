# 会话：2026-02-11

## 目标
- 初始化 `learn/` 研究笔记框架
- 建立 topic map（单层目录）
- 确认后续记录约定

## 讨论记录
- `learn/` 用于沉淀“结论 + 证据锚点 + 边界”，避免只有聊天上下文而难以追踪。
- topics 只做单层：降低移动成本，避免过度预分类。
- 一次 prompt 的事件链（interactive）：`InteractiveMode` 输入 → `AgentSession.prompt()` → `Agent.prompt()`/`agentLoop()` → `pi-ai streamSimple()` → tool execution → `AgentSession.subscribe()` → UI 渲染（事件驱动）。
- 进一步细化上述过程：补充 step-by-step 拆解、事件时间线，以及 `toolCall`（模型意图）与 `tool_execution_*`（执行状态）的关系。
- RPC mode：pi 以常驻进程方式运行，通过 stdin/stdout 的 JSON Lines 协议收命令、吐事件；适合 IDE/GUI/服务集成。
- 阅读 `packages/agent` 源码建议从 `Agent` 类入手：先看 public API + state/event，再下钻 `agentLoop()` 算法与类型词汇表。
- “agent 自己写工具”需要澄清：agent 只能调用已注册工具；写新工具是宿主/扩展的事情（可让模型生成扩展代码，但需宿主加载/启用）。
- extensions（扩展）机制要点：加载期只做注册（tools/commands/handlers/flags/shortcuts/renderers/providers），运行期由 `ExtensionRunner` 绑定 session/agent/ui；工具执行前后可触发 `tool_call/tool_result` 事件用于拦截与改写；`resources_discover` 允许扩展 skills/prompts/themes。
- extensions 机制进一步细化（纯文字版）：补充了扩展的“运行时对象/职责”、启动到 prompt 再到工具调用的完整时间线、extension commands 与 input/before_agent_start 的执行顺序、以及工具拦截层的 fail-open/fail-closed 边界。
- 扩展为何在“编译/打包后的程序”里仍可加载：因为 pi 在运行时用 `jiti` 动态导入 TS/JS 扩展；在 Bun binary 场景通过 `virtualModules` 将宿主依赖内嵌并暴露给扩展 import。
- extensions 修改 system prompt：通过 `before_agent_start` 事件可替换本轮 turn 的 system prompt（多扩展链式覆盖）；通过 `resources_discover` 可间接改变 base system prompt 的构建输入，从而更持久影响后续 turns。
- subagent/“自己调用自己”：pi core 不内置 sub-agents；示例扩展通过启动 `pi --mode json -p --no-session` 子进程来实现隔离上下文的 subagent，并解析 JSON 事件流聚合回主 UI。
- subagent 子进程“可观测性”：子进程在 `--mode json -p` 下把 session 事件逐行输出到 stdout（JSONL）；父扩展逐行解析事件，并用 `onUpdate(...)` 把子进程进度映射为主会话工具输出更新，因此它不是“只给最终字符串”的黑箱。

## 产出
- [learn/README.md](../README.md)
- [learn/SUMMARY.md](../SUMMARY.md)
- [agents：一次 prompt 的完整事件链（输入→LLM→工具→UI）](../agents/prompt-to-ui-event-chain.md)（补充：一步一步分解与时间线）
- [cli：RPC mode（stdin/stdout JSON 协议）](../cli/rpc-mode.md)
- [agents：阅读 packages/agent 源码的起点与路线](../agents/agent-package-reading-start.md)
- [agents：工具（tools）是谁写的？agent 能不能“自己写工具”](../agents/tools-authoring.md)
- [agents：pi coding-agent 的 extensions（扩展）机制：设计与实现](../agents/extensions-design-and-implementation.md)
- [agents：为什么“编译后的 pi”仍然能加载 extensions 代码？](../agents/extensions-loading-in-compiled-binary.md)
- [agents：extensions 如何修改 system prompt？](../agents/extensions-system-prompt-modification.md)
- [agents：没有内置 subagent，但可以用“pi 调 pi”实现（subagent 扩展示例）](../agents/subagents-via-self-invocation.md)
- [agents：subagent 子进程的“可观测性”是怎么做的？它和“黑箱 subagent”有什么区别？](../agents/subagent-observability.md)

## 待办
- 选择第一个要深挖的 topic（例如 `agents` / `llm` / `cli` / `pods`）
- 为该 topic 新建 1 篇“问题驱动”的笔记（`learn/<topic>/<name>.md`）并登记到 `SUMMARY.md`
